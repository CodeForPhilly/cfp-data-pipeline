name: main
on:
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy airflow
    runs-on: ubuntu-18.04
    steps:
      - name: Create SSH key
        run: |
          mkdir -p ~/.ssh/
          echo "$PROD_SSHKEY" > ~/.ssh/private.key
          sudo chmod 600 ~/.ssh/private.key
          echo "$PROD_SSHKNOWNHOSTS" > ~/.ssh/known_hosts
        shell: bash
        env:
          PROD_SSHKEY: ${{secrets.PROD_SSHKEY}}
          PROD_SSHKNOWNHOSTS: ${{secrets.SSHKNOWNHOSTS}}
      - name: Make .env
        uses: SpicyPizza/create-envfile@v1
        with:
          envkey_DEFAULT_USER: ${{ secrets.DEFAULT_USER }}
          envkey_DEFAULT_PASSWORD: ${{ secrets.DEFAULT_PASSWORD }}
          envkey_LADDR_DB_USER: ${{ secrets.LADDR_DB_USER }}
          envkey_LADDR_DB_PASS: ${{ secrets.LADDR_DB_PASS }}
          envkey_FERNET_KEY: ${{ secrets.FERNET_KEY }}
          envkey_SECRET_KEY: ${{ secrets.SECRET_KEY }}
          envkey_SLACK_BOT_USER_OAUTH_TOKEN: ${{ secrets.SLACK_BOT_USER_OAUTH_TOKEN }}
          file_name: .env
      - name: Copy .env to server
        run: |
          # Should definitely re-enable strict host key checking
          scp -i ~/.ssh/private.key -o StrictHostKeyChecking=no .env "$PROD_USERNAME"@"$PROD_HOST":.env
          ssh -i ~/.ssh/private.key -o StrictHostKeyChecking=no "$PROD_USERNAME"@"$PROD_HOST" "
            rm -rf cfp-data-pipeline
            git clone https://github.com/CodeForPhilly/cfp-data-pipeline.git
            mv .env cfp-data-pipeline
            cd cfp-data-pipeline && docker-compose down && docker-compose up -d
          "
        env:
          PROD_USERNAME: ${{ secrets.PROD_USERNAME }}
          PROD_HOST: ${{ secrets.PROD_HOST }}
